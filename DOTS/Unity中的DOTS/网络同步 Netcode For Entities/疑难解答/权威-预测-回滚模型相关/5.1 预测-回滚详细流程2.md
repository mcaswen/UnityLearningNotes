“先回滚到上一个**完整预测备份**（如 118），再逐 Tick 复演到新快照 Tick（120），之后继续向目标 Tick 预测”这一流程更稳健。原因在于：新快照改变的不只是“120 这一瞬”的值，还可能隐含对 119 的状态演化提出不同约束；若直接从 120 起算，跨 Tick 的累计量（积分速度、冷却计时、触发门闩、队列消费等）会以错误上下文进入 121 之后的预测，违反“相同输入序列 + 相同起点 → 相同下一帧”的可复演前提。

---

## 原理（为什么要回到“上一个完整预测备份”而非直接从 120 起算）

**可复演的必要条件**由三项构成：

1. **统一时间刻度**：逐 Tick 固定步（逻辑 delta 不随帧长变动）。
    
2. **输入对齐**：每个 Tick 使用与服务器相同编号的输入命令。
    
3. **起点一致**：从一个**未被本地误预测污染**的状态开始重放。
    

新快照抵达 Tick = 120 时，仅把“120 的权威值”写回并不足以满足第 3 条。因为：

- **跨 Tick 累计依赖**：120 的正确值通常依赖 119 的正确值（积分、计数、去抖动、有限状态机边界）。若 119 曾被误预测，则“从 120 起算”会携带错误的累计量。
    
- **门闩与一次性副作用**：诸如“首次完整预测触发”的事件在 119 是否发生，会直接影响 120 的输入解释与状态转移；跳过 119 的复演会让门闩状态错位。
    
- **多实体因果**：被校正的实体与其依赖方之间的交互往往跨 2–3 个 Tick 才结算完毕（例如击中登记、命中后位移、再触发冷却）。从 118 这类“上一次**完整预测**备份”开始复演，才能把这条因果链恢复到与服务器一致的上下文。
    

因此，**回滚起点 = min(“新快照 Tick”, “上一次完整预测 Tick 的历史备份”)** 是更严格的选择。若历史环形缓冲中存在 118 的“完整预测备份”，以它为起点重放 119 与 120，才能保证 121 往后满足可复演前提。

---

## 执行次序（概念级过程）

1. **应用快照**：把快照 120 写入被更新的预测实体，并标记“需要校正”。
    
2. **选取回滚起点**：对被标记的实体，取“最近一次**完整预测**的历史备份 Tick”，若存在且 ≤120，则以该 Tick（例：118）为起点；若无历史（新生实体或历史不可用），退化为以 120 为起点。
    
3. **恢复历史**：从预测历史缓冲恢复到 118 的干净镜像。
    
4. **逐 Tick 重放**：依序重放 119、120（每步使用对应 Tick 的输入命令；一次性副作用只在“首次完整预测”触发）。
    
5. **继续预测**：从 121 开始向当前/目标 Tick 继续预测。
    
6. **末尾备份**：在本轮“最后一个**完整预测** Tick”结束后写入新的历史备份，为下一次校正提供干净起点。
    

---

## 与“直接从 120 起算”的对比

- **从 120 起算**：会把“119 的误差”折叠进 121 的预测，造成冷却提前/延后、位移能量误积、一次性事件重入或漏发。
    
- **从 118 复演到 120**：恢复 119→120 的**因果轨迹**，确保 121 的“上一帧状态、门闩、累计量”与服务器一致，再继续预测时才满足可复演条件。
    

---

## 示例

**设定**：移动使用速度积分；跳跃使用“落地→冷却 2 Tick→允许起跳”的门闩。

- 本地误预测：在 119 误判“已落地”，提前解锁起跳；120 时客户端状态 = “可起跳”。
    
- 新快照 120：服务器标明“119 未落地，120 仍在空中且冷却未完”。
    
- **从 120 起算**：121 的本地起跳检查看到“可起跳”，与服务器不一致。
    
- **从 118 复演**：119 正确“未落地”，120 冷却未完；至 121 仍“不可起跳”，与服务器一致。
    

---

## 边界与例外

- **无历史可用**：新生成 Ghost 或历史缓冲不足时，只能以快照 Tick 为起点；此时的正确性依赖于“快照内容够完整”与“门闩/累计量能从快照派生”。
    
- **选择性回滚**：通常仅对“被快照改写的预测实体”及因果相关的子集做复演；未受影响的预测实体可保持当前历史，以降低成本。
    
- **历史粒度**：历史在“**完整预测** Tick”时刻落点；partial tick 不作为备份锚点，避免不稳定起点。
    

---

## 收束

“回到上一个**完整预测备份**再复演到新快照 Tick”更严格地满足**统一刻度、输入对齐、起点一致**三要素；在存在跨 Tick 因果与累计量的系统里，这是保证“永远由相同的输入序列与上下文得出下一帧”的必要条件。直接从快照 Tick 起算属于**退化路径**，仅在历史缺失或实体新生等场景下使用。